{{/*
  Generated by MDDE
  Entity: customer
  Stereotype: dim_scd2
*/}}

{{ config(
    materialized='incremental',
    unique_key='customer_sk',
    incremental_strategy='merge',
    merge_update_columns=['customer_name', 'email', 'tier', 'country', 'valid_to', 'is_current', '_updated_at']
) }}

WITH source_data AS (
    SELECT
        customer_id,
        customer_name,
        email,
        signup_date,
        tier,
        country,
        _source_system,
        _batch_id
    FROM {{ ref('stg_customer') }}
),

{% if is_incremental() %}
existing_current AS (
    SELECT *
    FROM {{ this }}
    WHERE is_current = TRUE
),

changes AS (
    SELECT
        s.*,
        e.customer_sk,
        CASE
            WHEN e.customer_sk IS NULL THEN 'INSERT'
            WHEN s.customer_name != e.customer_name
                OR s.email != e.email
                OR s.tier != e.tier
                OR s.country != e.country
            THEN 'UPDATE'
            ELSE 'NO_CHANGE'
        END AS _change_type
    FROM source_data s
    LEFT JOIN existing_current e ON s.customer_id = e.customer_id
),

-- Close existing records that have changes
records_to_close AS (
    SELECT
        e.customer_sk,
        e.customer_id,
        e.customer_name,
        e.email,
        e.signup_date,
        e.tier,
        e.country,
        e.valid_from,
        CURRENT_TIMESTAMP() AS valid_to,
        FALSE AS is_current,
        e._created_at,
        CURRENT_TIMESTAMP() AS _updated_at,
        e._source_system,
        e._batch_id
    FROM existing_current e
    INNER JOIN changes c ON e.customer_id = c.customer_id
    WHERE c._change_type = 'UPDATE'
),

-- New records (inserts and new versions of updates)
new_records AS (
    SELECT
        {{ dbt_utils.generate_surrogate_key(['customer_id', 'CURRENT_TIMESTAMP()']) }} AS customer_sk,
        customer_id,
        customer_name,
        email,
        signup_date,
        tier,
        country,
        CURRENT_TIMESTAMP() AS valid_from,
        CAST('9999-12-31 23:59:59' AS TIMESTAMP) AS valid_to,
        TRUE AS is_current,
        CURRENT_TIMESTAMP() AS _created_at,
        CURRENT_TIMESTAMP() AS _updated_at,
        _source_system,
        _batch_id
    FROM changes
    WHERE _change_type IN ('INSERT', 'UPDATE')
)

SELECT * FROM records_to_close
UNION ALL
SELECT * FROM new_records

{% else %}
-- Initial load
SELECT
    {{ dbt_utils.generate_surrogate_key(['customer_id']) }} AS customer_sk,
    customer_id,
    customer_name,
    email,
    signup_date,
    tier,
    country,
    CURRENT_TIMESTAMP() AS valid_from,
    CAST('9999-12-31 23:59:59' AS TIMESTAMP) AS valid_to,
    TRUE AS is_current,
    CURRENT_TIMESTAMP() AS _created_at,
    CURRENT_TIMESTAMP() AS _updated_at,
    _source_system,
    _batch_id
FROM source_data

{% endif %}
