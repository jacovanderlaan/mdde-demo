-- Generated by MDDE
-- Entity: customer
-- Stereotype: dim_scd2 (Slowly Changing Dimension Type 2)
-- Target: Snowflake

CREATE OR REPLACE TABLE business.dim_customer (
    -- Surrogate key
    customer_sk NUMBER AUTOINCREMENT PRIMARY KEY,

    -- Business key
    customer_id NUMBER NOT NULL,

    -- Attributes
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    signup_date DATE NOT NULL,
    tier VARCHAR(20) NOT NULL,
    country VARCHAR(2),

    -- SCD2 tracking columns
    valid_from TIMESTAMP_NTZ NOT NULL DEFAULT CURRENT_TIMESTAMP(),
    valid_to TIMESTAMP_NTZ DEFAULT '9999-12-31 23:59:59',
    is_current BOOLEAN DEFAULT TRUE,

    -- Audit columns
    _created_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    _updated_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    _source_system VARCHAR(100),
    _batch_id VARCHAR(50)
);

-- Business key uniqueness for current records
CREATE UNIQUE INDEX IF NOT EXISTS idx_customer_bk_current
ON business.dim_customer (customer_id)
WHERE is_current = TRUE;

-- Performance indexes
CREATE INDEX IF NOT EXISTS idx_customer_tier ON business.dim_customer (tier);
CREATE INDEX IF NOT EXISTS idx_customer_country ON business.dim_customer (country);

-- Comments
COMMENT ON TABLE business.dim_customer IS 'Customer master data with tier classification';
COMMENT ON COLUMN business.dim_customer.customer_id IS 'Unique identifier for the customer';
COMMENT ON COLUMN business.dim_customer.email IS 'Primary email address (PII: email)';
COMMENT ON COLUMN business.dim_customer.tier IS 'Loyalty tier classification. Domain: customer_tier';
