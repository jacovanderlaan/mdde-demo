-- Generated by MDDE
-- Entity: customer
-- Stereotype: dim_scd2 (Slowly Changing Dimension Type 2)
-- Target: DuckDB

CREATE TABLE IF NOT EXISTS business.dim_customer (
    -- Surrogate key
    customer_sk INTEGER PRIMARY KEY,

    -- Business key
    customer_id INTEGER NOT NULL,

    -- Attributes
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    signup_date DATE NOT NULL,
    tier VARCHAR(20) NOT NULL,
    country VARCHAR(2),

    -- SCD2 tracking columns
    valid_from TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    valid_to TIMESTAMP DEFAULT '9999-12-31 23:59:59',
    is_current BOOLEAN DEFAULT TRUE,

    -- Audit columns
    _created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    _updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    _source_system VARCHAR(100),
    _batch_id VARCHAR(50)
);

-- Indexes
CREATE INDEX idx_customer_bk ON business.dim_customer (customer_id);
CREATE INDEX idx_customer_current ON business.dim_customer (customer_id) WHERE is_current = TRUE;
CREATE INDEX idx_customer_tier ON business.dim_customer (tier);
