-- Generated by MDDE
-- Entity: customer
-- Stereotype: dim_scd2 (Slowly Changing Dimension Type 2)
-- Target: Databricks (Delta Lake)

CREATE TABLE IF NOT EXISTS business.dim_customer (
    -- Surrogate key
    customer_sk BIGINT GENERATED ALWAYS AS IDENTITY,

    -- Business key
    customer_id INT NOT NULL,

    -- Attributes
    customer_name STRING NOT NULL,
    email STRING,
    signup_date DATE NOT NULL,
    tier STRING NOT NULL,
    country STRING,

    -- SCD2 tracking columns
    valid_from TIMESTAMP NOT NULL,
    valid_to TIMESTAMP,
    is_current BOOLEAN DEFAULT TRUE,

    -- Audit columns
    _created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    _updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    _source_system STRING,
    _batch_id STRING
)
USING DELTA
COMMENT 'Customer master data with tier classification'
TBLPROPERTIES (
    'delta.autoOptimize.optimizeWrite' = 'true',
    'delta.autoOptimize.autoCompact' = 'true',
    'delta.enableChangeDataFeed' = 'true'
);

-- Add constraints
ALTER TABLE business.dim_customer ADD CONSTRAINT pk_customer PRIMARY KEY (customer_sk);

-- Column comments
ALTER TABLE business.dim_customer ALTER COLUMN customer_id COMMENT 'Unique identifier for the customer';
ALTER TABLE business.dim_customer ALTER COLUMN email COMMENT 'Primary email address (PII: email)';
ALTER TABLE business.dim_customer ALTER COLUMN tier COMMENT 'Loyalty tier classification. Domain: customer_tier';
